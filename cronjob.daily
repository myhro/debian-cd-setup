#!/bin/bash

SETUP_DIR=$(dirname $0)

#echo "BAILING OUT OF DAILY BUILD" | mail steve@einval.com
#exit 1

if [ "$ARCHES"x = ""x ] ; then
    ARCHES="alpha amd64 arm hppa i386 ia64 m68k mips mipsel powerpc sparc"
fi

cd $SETUP_DIR &&
if lockfile -r0 .debian-cd.lock ; then

    cd debian-cd && svn up ; cd ..
    CURRENT=`pwd`

    . images4testing_d-i

    cd debian-cd && CODENAME=etch make update-popcon ; cd ..
    cd debian-cd && CODENAME=sid make update-popcon ; cd ..

    export DATE=`/bin/date -u +%Y%m%d`
    export PUBDIRJIG=/org/cdimage.debian.org/www/testing/daily-builds
    export PUBDIRISO=/org/cdimage.debian.org/www/testing/daily-builds

    for arch in $ARCHES
    do
        echo "Building $arch:"
        ARCH_DI_DIR=/org/gluck.debian.org
        echo "  $arch etch bc"
        OMIT_RELEASE_NOTES=1 OMIT_MANUAL=1 NORECOMMENDS=1 NOSUGGESTS=1 COMPLETE=0 INSTALLER_CD=1 TASK=tasks/debian-installer-etch DOJIGDO=0 DI=etch DI_DIST="$DI_DIST" ./testingcds "$arch"
        cd $PUBDIRISO/etch_d-i/$DATE/$arch/iso-cd && zsyncmake -e *businesscard*iso > /dev/null && cd $CURRENT
        echo "  $arch etch netinst"
        OMIT_RELEASE_NOTES=1 OMIT_MANUAL=1 NORECOMMENDS=1 NOSUGGESTS=1 COMPLETE=0 INSTALLER_CD=2 TASK=tasks/debian-installer+kernel-etch DOJIGDO=0 DI=etch DI_DIST="$DI_DIST" ./testingcds "$arch"
        cd $PUBDIRISO/etch_d-i/$DATE/$arch/iso-cd && md5sum *.iso > MD5SUMS && cd $CURRENT
        cd $PUBDIRISO/etch_d-i/$DATE/$arch/iso-cd && zsyncmake -e *netinst*iso > /dev/null && cd $CURRENT
        echo "  $arch sid bc"
        OMIT_RELEASE_NOTES=1 OMIT_MANUAL=1 NORECOMMENDS=1 NOSUGGESTS=1 COMPLETE=0 INSTALLER_CD=1 TASK=tasks/debian-installer-sid DOJIGDO=0 DI=sid DI_WWW_HOME=default DI_DIR="$ARCH_DI_DIR" ./testingcds "$arch"
        cd $PUBDIRISO/sid_d-i/$DATE/$arch/iso-cd && zsyncmake -e *businesscard*iso > /dev/null && cd $CURRENT
        echo "  $arch sid netinst"
        OMIT_RELEASE_NOTES=1 OMIT_MANUAL=1 NORECOMMENDS=1 NOSUGGESTS=1 COMPLETE=0 INSTALLER_CD=2 TASK=tasks/debian-installer+kernel-sid DOJIGDO=0 DI=sid DI_WWW_HOME=default DI_DIR="$ARCH_DI_DIR" ./testingcds "$arch"
        cd $PUBDIRISO/sid_d-i/$DATE/$arch/iso-cd && md5sum *.iso > MD5SUMS && cd $CURRENT
        cd $PUBDIRISO/sid_d-i/$DATE/$arch/iso-cd && zsyncmake -e *netinst*iso > /dev/null && cd $CURRENT
    done

    echo "Preseeding:"
    ssh farbror.acc.umu.se bin/preseeding "$DATE"
    echo "Sync across to farbror.acc.umu.se:"
    rsync -rHltvz /org/cdimage.debian.org/www/testing/daily-builds/ \
        farbror.acc.umu.se:/export/ftp/cdimage/daily-builds/
    echo "Remove extra dailies:"
    ssh farbror.acc.umu.se bin/remove_extra_dailies

    echo "Clean up old builds on build machine:"
    for DIR in $PUBDIRISO/*
    do
        cd $DIR
        for THIS in 20*
        do
            if [ $THIS != $DATE ] ; then
                echo "  Deleting $DIR/$THIS"
                rm -rf $DIR/$THIS
            fi
        done
    done

    cd $SETUP_DIR
    rm -f .debian-cd.lock
fi
